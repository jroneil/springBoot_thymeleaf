<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<body>

    <div th:replace="~{layout :: layout(
        content=~{::content}, 
        pageTitle='User Management',
        infoContent=~{::pageInfo},
        showInfoPanel=true
    )}">
        <!-- Info Fragment -->
        <div th:fragment="pageInfo">
            <h3 class="text-lg font-semibold text-blue-400 mb-3">User & Role Control</h3>
            <p class="text-sm text-gray-400 leading-relaxed mb-4">
                This unified form allows you to edit core user profile information and manage role assignments in a
                single transaction.
            </p>
            <div class="p-3 bg-blue-900/20 border border-blue-800/50 rounded-lg space-y-2">
                <p class="text-xs text-blue-400 font-medium">Features:</p>
                <ul class="text-xs text-gray-500 list-disc list-inside">
                    <li>Case-insensitive uniqueness</li>
                    <li>Atomic updates</li>
                    <li>Unsaved changes detection</li>
                </ul>
            </div>
        </div>

        <div th:fragment="content">

            <div class="max-w-4xl mx-auto bg-gray-800 p-8 rounded-xl shadow-2xl border border-gray-700">

                <!-- Global Error Banner -->
                <div th:if="${#fields.hasErrors('${userManageForm.*}')}"
                    class="bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded-lg relative mb-6"
                    role="alert">
                    <strong class="font-bold">Please fix the errors below.</strong>
                </div>

                <!-- User Selection Dropdown -->
                <div class="mb-8 p-4 bg-gray-900/50 rounded-lg border border-gray-700">
                    <label for="userSelect" class="block text-sm font-medium text-gray-400 mb-2">Identify User to
                        Manage</label>
                    <select id="userSelect"
                        class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all cursor-pointer"
                        onchange="handleUserChange(this.value)">
                        <option th:each="u : ${users}" th:value="${u.id}"
                            th:text="${u.username + ' (' + u.displayName + ')'}"
                            th:selected="${selectedUser != null && u.id == selectedUser.id}"></option>
                    </select>
                </div>

                <form th:action="@{/users/manage/save}" th:object="${userManageForm}" method="post" id="manageForm"
                    class="space-y-8" th:if="${selectedUser != null}">

                    <input type="hidden" th:field="*{userId}" />

                    <!-- Section: Profile Fields -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="col-span-1 md:col-span-2">
                            <h3 class="text-lg font-medium text-gray-200 border-b border-gray-700 pb-2 mb-4">Profile
                                Information</h3>
                        </div>

                        <!-- Username -->
                        <div class="flex flex-col">
                            <label th:for="${#ids.next('username')}"
                                class="text-sm font-medium text-gray-400 mb-2">Username</label>
                            <input type="text" th:field="*{username}"
                                th:classappend="${#fields.hasErrors('username')} ? 'is-invalid' : ''"
                                class="form-input w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-gray-100" />
                            <p th:if="${#fields.hasErrors('username')}" th:errors="*{username}" class="field-error"></p>
                        </div>

                        <!-- Email -->
                        <div class="flex flex-col">
                            <label th:for="${#ids.next('email')}" class="text-sm font-medium text-gray-400 mb-2">Email
                                Address</label>
                            <input type="email" th:field="*{email}"
                                th:classappend="${#fields.hasErrors('email')} ? 'is-invalid' : ''"
                                class="form-input w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-gray-100" />
                            <p th:if="${#fields.hasErrors('email')}" th:errors="*{email}" class="field-error"></p>
                        </div>

                        <!-- Display Name -->
                        <div class="flex flex-col md:col-span-2">
                            <label th:for="${#ids.next('displayName')}"
                                class="text-sm font-medium text-gray-400 mb-2">Full Display Name</label>
                            <input type="text" th:field="*{displayName}"
                                th:classappend="${#fields.hasErrors('displayName')} ? 'is-invalid' : ''"
                                class="form-input w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-gray-100" />
                            <p th:if="${#fields.hasErrors('displayName')}" th:errors="*{displayName}"
                                class="field-error"></p>
                        </div>

                        <!-- Section: Telephone -->
                        <div class="col-span-1 md:col-span-2 mt-4">
                            <h3 class="text-lg font-medium text-gray-200 border-b border-gray-700 pb-2 mb-4">Contact
                                Details</h3>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                                <!-- International Part -->
                                <div class="flex flex-col">
                                    <label th:for="${#ids.next('countryCode')}"
                                        class="text-sm font-medium text-gray-400 mb-2">International</label>
                                    <input type="text" th:field="*{countryCode}" placeholder="+1"
                                        th:classappend="${#fields.hasErrors('countryCode')} ? 'is-invalid' : ''"
                                        class="form-input w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-gray-100" />
                                    <p th:if="${#fields.hasErrors('countryCode')}" th:errors="*{countryCode}"
                                        class="field-error"></p>
                                </div>
                                <!-- Phone Number -->
                                <div class="flex flex-col md:col-span-2">
                                    <label th:for="${#ids.next('phoneNumber')}"
                                        class="text-sm font-medium text-gray-400 mb-2">Telephone Number</label>
                                    <input type="text" th:field="*{phoneNumber}" placeholder="555-0123"
                                        th:classappend="${#fields.hasErrors('phoneNumber')} ? 'is-invalid' : ''"
                                        class="form-input w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-gray-100" />
                                    <p th:if="${#fields.hasErrors('phoneNumber')}" th:errors="*{phoneNumber}"
                                        class="field-error"></p>
                                </div>
                                <!-- Extension -->
                                <div class="flex flex-col">
                                    <label th:for="${#ids.next('extension')}"
                                        class="text-sm font-medium text-gray-400 mb-2">Extension</label>
                                    <input type="text" th:field="*{extension}" placeholder="x123"
                                        th:classappend="${#fields.hasErrors('extension')} ? 'is-invalid' : ''"
                                        class="form-input w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-gray-100" />
                                    <p th:if="${#fields.hasErrors('extension')}" th:errors="*{extension}"
                                        class="field-error"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section: Roles Listbox -->
                    <div>
                        <h3 class="text-lg font-medium text-gray-200 border-b border-gray-700 pb-2 mb-4">Role
                            Assignments</h3>

                        <div class="grid grid-cols-1 md:grid-cols-[1fr,auto,1fr] gap-4 items-center">
                            <!-- Available -->
                            <div class="flex flex-col">
                                <label
                                    class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Available</label>
                                <select id="availableRoles" multiple size="8"
                                    class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2 text-gray-100 focus:ring-2 focus:ring-blue-500 font-mono text-sm">
                                    <option th:each="r : ${availableRoles}" th:value="${r.id}" th:text="${r.name}">
                                    </option>
                                </select>
                            </div>

                            <!-- Controls -->
                            <div class="flex md:flex-col gap-2 justify-center">
                                <button type="button" onclick="moveSelected('availableRoles', 'assignedRoles')"
                                    class="btn btn-sm bg-gray-700 border-gray-600">&rarr;</button>
                                <button type="button" onclick="moveSelected('assignedRoles', 'availableRoles')"
                                    class="btn btn-sm bg-gray-700 border-gray-600">&larr;</button>
                            </div>

                            <!-- Assigned -->
                            <div class="flex flex-col">
                                <label
                                    class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Assigned</label>
                                <select th:field="*{assignedRoleIds}" id="assignedRoles" multiple size="8"
                                    th:classappend="${#fields.hasErrors('assignedRoleIds')} ? 'is-invalid' : ''"
                                    class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2 text-gray-100 focus:ring-2 focus:ring-blue-500 font-mono text-sm">
                                    <option th:each="r : ${assignedRoles}" th:value="${r.id}" th:text="${r.name}">
                                    </option>
                                </select>
                                <p th:if="${#fields.hasErrors('assignedRoleIds')}" th:errors="*{assignedRoleIds}"
                                    class="field-error"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Footer Actions -->
                    <div class="flex items-center justify-between pt-6 border-t border-gray-700 mt-8">
                        <div>
                            <button type="button" onclick="confirmClearRoles()"
                                class="btn btn-sm bg-red-900/20 border-red-800 text-red-300 hover:bg-red-800/40">
                                Clear All Roles
                            </button>
                        </div>

                        <div class="flex items-center gap-4">
                            <span id="dirtyBadge" class="dirty-badge" style="display:none;">Unsaved changes</span>
                            <button type="submit" id="saveBtn" class="btn btn-primary px-10" disabled>
                                Save Changes
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Hidden form for clear action -->
                <form id="clearForm" th:action="@{/users/manage/clear-roles}" method="post" style="display:none;">
                    <input type="hidden" name="userId" th:value="${selectedUser != null ? selectedUser.id : ''}" />
                </form>
            </div>

            <script th:inline="javascript">
                let isDirty = false;
                const initialUserId = /*[[${selectedUser != null ? selectedUser.id : ''}]]*/ '';

                function setDirty(dirty) {
                    isDirty = dirty;
                    document.getElementById('saveBtn').disabled = !dirty;
                    document.getElementById('dirtyBadge').style.display = dirty ? 'inline-block' : 'none';
                }

                // Track inputs
                document.querySelectorAll('.form-input').forEach(el => {
                    el.addEventListener('input', () => setDirty(true));
                });

                function moveSelected(sourceId, targetId) {
                    const source = document.getElementById(sourceId);
                    const target = document.getElementById(targetId);
                    const selected = Array.from(source.selectedOptions);

                    if (selected.length > 0) {
                        setDirty(true);
                        selected.forEach(opt => target.appendChild(opt));

                        // Sort target
                        const opts = Array.from(target.options);
                        opts.sort((a, b) => a.text.localeCompare(b.text));
                        target.innerHTML = '';
                        opts.forEach(opt => target.appendChild(opt));
                    }
                }

                function handleUserChange(val) {
                    if (isDirty) {
                        if (confirm("You have unsaved changes. Discard and switch user?")) {
                            window.location.href = '/users/manage?userId=' + val;
                        } else {
                            document.getElementById('userSelect').value = initialUserId;
                        }
                    } else {
                        window.location.href = '/users/manage?userId=' + val;
                    }
                }

                function confirmClearRoles() {
                    if (confirm("Are you sure you want to remove ALL roles for this user?")) {
                        document.getElementById('clearForm').submit();
                    }
                }

                document.getElementById('manageForm').addEventListener('submit', function () {
                    const assigned = document.getElementById('assignedRoles');
                    Array.from(assigned.options).forEach(opt => opt.selected = true);
                });
            </script>

            <style>
                .is-invalid {
                    border: 2px solid #ef4444 !important;
                    background-color: rgba(239, 68, 68, 0.05) !important;
                }

                .field-error {
                    color: #ef4444;
                    font-size: 0.75rem;
                    margin-top: 4px;
                    font-style: italic;
                }
            </style>
        </div>
    </div>
</body>

</html>